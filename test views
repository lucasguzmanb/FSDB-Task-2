--test my_data

CREATE OR REPLACE VIEW my_data AS
SELECT user_id, id_card, name, surname1, surname2, birthdate, town, province, address, email, phone
FROM users
WHERE user_id = '0501252527';
SELECT * FROM my_data;
--


CREATE OR REPLACE VIEW my_loans AS
SELECT
  l.signature,
  l.user_id,
  l.stopdate,
  l.town,
  l.province,
  l.type,
  l.time,
  l.return,
  p.text AS post,
  p.post_date,
  p.likes,
  p.dislikes
FROM loans l
LEFT JOIN posts p ON l.signature = p.signature
                 AND l.user_id = p.user_id
                 AND l.stopdate = p.stopdate
WHERE l.user_id = ''9994309848';


CREATE OR REPLACE TRIGGER trg_update_my_loans
INSTEAD OF UPDATE ON my_loans
FOR EACH ROW
BEGIN
  IF :OLD.post IS NULL THEN
    INSERT INTO posts (signature, user_id, stopdate, text, post_date, likes, dislikes)
    VALUES (:OLD.signature, :OLD.user_id, :OLD.stopdate, :NEW.post, SYSTIMESTAMP, 0, 0);
  ELSE
    UPDATE posts
    SET text = :NEW.post,
        post_date = SYSTIMESTAMP
    WHERE signature = :OLD.signature
      AND user_id = :OLD.user_id
      AND stopdate = :OLD.stopdate;
  END IF;
END;
/


--test para ver si se modifica el post, la post_date se actualiza autom√°ticamente a la fecha y hora actual

SELECT post, post_date
FROM my_loans
WHERE signature = 'YE049' AND stopdate = TO_DATE('12-NOV-24', 'DD-MON-YY');

UPDATE my_loans
SET post = 'Post actualizado para probar la fecha'
WHERE signature = 'YE049' AND stopdate = TO_DATE('12-NOV-24', 'DD-MON-YY');

SELECT post, post_date
FROM my_loans
WHERE signature = 'YE049' AND stopdate = TO_DATE('12-NOV-24', 'DD-MON-YY');

UPDATE my_loans
SET post = 'Este es un nuevo comentario de prueba'
WHERE signature = 'YE049' AND stopdate = TO_DATE('12-NOV-24', 'DD-MON-YY');

-----my_reservations------------


CREATE OR REPLACE VIEW my_reservations AS
SELECT
  signature,
  stopdate AS reservation_date,
  town,
  province
FROM loans
WHERE user_id = '9994309848'
  AND type = 'R';


CREATE OR REPLACE TRIGGER trg_insert_my_reservations
INSTEAD OF INSERT ON my_reservations
FOR EACH ROW
BEGIN
  INSERT INTO loans (
    signature,
    user_id,
    stopdate,
    town,
    province,
    type,
    time,
    return
  )
  VALUES (
    :NEW.signature,
    '9994309848',
    :NEW.reservation_date,
    :NEW.town,
    :NEW.province,
    'R',
    0,
    NULL
  );
END;
/


CREATE OR REPLACE TRIGGER trg_delete_my_reservations
INSTEAD OF DELETE ON my_reservations
FOR EACH ROW
BEGIN
  DELETE FROM loans
  WHERE signature = :OLD.signature
    AND user_id = '9994309848'
    AND stopdate = :OLD.reservation_date
    AND type = 'R';
END;
/


CREATE OR REPLACE TRIGGER trg_update_my_reservations
INSTEAD OF UPDATE ON my_reservations
FOR EACH ROW
BEGIN
  UPDATE loans
  SET stopdate = :NEW.reservation_date
  WHERE signature = :OLD.signature
    AND user_id = '9994309848'
    AND stopdate = :OLD.reservation_date
    AND type = 'R';
END;
/

